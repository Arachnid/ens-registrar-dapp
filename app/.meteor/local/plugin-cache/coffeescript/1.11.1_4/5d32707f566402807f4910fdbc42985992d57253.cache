{"source":"__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;\nvar indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },\n  slice = [].slice;\n\n_.extend(TAPi18n.prototype, {\n  _languageSpecificTranslators: null,\n  _languageSpecificTranslatorsTrackers: null,\n  _getLanguageFilePath: function(lang_tag) {\n    var path;\n    if (!this._enabled()) {\n      return null;\n    }\n    path = this.conf.cdn_path != null ? this.conf.cdn_path : this.conf.i18n_files_route;\n    path = path.replace(/\\/$/, \"\");\n    if (Meteor.isCordova && path[0] === \"/\") {\n      path = Meteor.absoluteUrl().replace(/\\/+$/, \"\") + path;\n    }\n    return path + \"/\" + lang_tag + \".json\";\n  },\n  _loadLanguage: function(languageTag) {\n    var dependencyLoadDfd, dfd, directDependencyLanguageTag, loadLanguageTag, project_languages;\n    dfd = new $.Deferred();\n    if (!this._enabled()) {\n      return dfd.reject(\"tap-i18n is not enabled in the project level, check tap-i18n README\");\n    }\n    project_languages = this._getProjectLanguages();\n    if (indexOf.call(project_languages, languageTag) >= 0) {\n      if (indexOf.call(this._loaded_languages, languageTag) < 0) {\n        loadLanguageTag = (function(_this) {\n          return function() {\n            var jqXHR;\n            jqXHR = $.getJSON(_this._getLanguageFilePath(languageTag));\n            jqXHR.done(function(data) {\n              _this._loadLangFileObject(languageTag, data);\n              _this._loaded_languages.push(languageTag);\n              return dfd.resolve();\n            });\n            return jqXHR.fail(function(xhr, error_code) {\n              return dfd.reject(\"Couldn't load language '\" + languageTag + \"' JSON: \" + error_code);\n            });\n          };\n        })(this);\n        directDependencyLanguageTag = indexOf.call(languageTag, \"-\") >= 0 ? languageTag.replace(/-.*/, \"\") : fallback_language;\n        if (languageTag !== fallback_language && indexOf.call(project_languages, directDependencyLanguageTag) >= 0) {\n          dependencyLoadDfd = this._loadLanguage(directDependencyLanguageTag);\n          dependencyLoadDfd.done((function(_this) {\n            return function() {\n              return loadLanguageTag();\n            };\n          })(this));\n          dependencyLoadDfd.fail((function(_this) {\n            return function(message) {\n              return dfd.reject((\"Loading process failed since dependency language '\" + directDependencyLanguageTag + \"' failed to load: \") + message);\n            };\n          })(this));\n        } else {\n          loadLanguageTag();\n        }\n      } else {\n        dfd.resolve();\n      }\n    } else {\n      dfd.reject([\"Language \" + languageTag + \" is not supported\"]);\n    }\n    return dfd.promise();\n  },\n  _registerHelpers: function(package_name, template) {\n    var helpers, tapI18nextProxy, underscore_helper;\n    if (package_name !== globals.project_translations_domain) {\n      tapI18nextProxy = this._getPackageI18nextProxy(this.packages[package_name].namespace);\n    } else {\n      tapI18nextProxy = this._getPackageI18nextProxy(globals.project_translations_domain);\n    }\n    underscore_helper = function() {\n      var args, key, options;\n      key = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];\n      options = (args.pop()).hash;\n      if (!_.isEmpty(args)) {\n        options.sprintf = args;\n      }\n      return tapI18nextProxy(key, options);\n    };\n    if (package_name !== globals.project_translations_domain) {\n      if ((Template[template] != null) && (Template[template].helpers != null)) {\n        helpers = {};\n        helpers[this.packages[package_name].helper_name] = underscore_helper;\n        Template[template].helpers(helpers);\n      }\n    } else {\n      UI.registerHelper(this.conf.helper_name, underscore_helper);\n      UI.registerHelper(\"languageTag\", (function(_this) {\n        return function() {\n          return _this.getLanguage();\n        };\n      })(this));\n    }\n  },\n  _getRegisterHelpersProxy: function(package_name) {\n    return (function(_this) {\n      return function(template) {\n        return _this._registerHelpers(package_name, template);\n      };\n    })(this);\n  },\n  _prepareLanguageSpecificTranslator: function(lang_tag) {\n    var dfd;\n    dfd = (new $.Deferred()).resolve().promise();\n    if (lang_tag in this._languageSpecificTranslatorsTrackers) {\n      return dfd;\n    }\n    this._languageSpecificTranslatorsTrackers[lang_tag] = new Tracker.Dependency;\n    if (!(lang_tag in this._languageSpecificTranslators)) {\n      dfd = this._loadLanguage(lang_tag).done((function(_this) {\n        return function() {\n          _this._languageSpecificTranslators[lang_tag] = _this._getSpecificLangTranslator(lang_tag);\n          return _this._languageSpecificTranslatorsTrackers[lang_tag].changed();\n        };\n      })(this));\n    }\n    return dfd;\n  },\n  _getPackageI18nextProxy: function(package_name) {\n    return (function(_this) {\n      return function(key, options, lang_tag) {\n        if (lang_tag == null) {\n          lang_tag = null;\n        }\n        if (((options != null ? options.lang : void 0) != null) && ((options != null ? options.lng : void 0) == null)) {\n          options.lng = options.lang;\n        }\n        if (((options != null ? options.lng : void 0) != null) && (lang_tag == null)) {\n          lang_tag = options.lng;\n          delete options.lng;\n        }\n        if (lang_tag != null) {\n          _this._prepareLanguageSpecificTranslator(lang_tag);\n          _this._languageSpecificTranslatorsTrackers[lang_tag].depend();\n          if (lang_tag in _this._languageSpecificTranslators) {\n            return _this._languageSpecificTranslators[lang_tag]((TAPi18n._getPackageDomain(package_name)) + \":\" + key, options);\n          } else {\n            return TAPi18next.t((TAPi18n._getPackageDomain(package_name)) + \":\" + key, options);\n          }\n        }\n        _this._language_changed_tracker.depend();\n        return TAPi18next.t((TAPi18n._getPackageDomain(package_name)) + \":\" + key, options);\n      };\n    })(this);\n  },\n  _onceEnabled: function() {\n    return this._registerHelpers(globals.project_translations_domain);\n  },\n  _abortPreviousSetLang: null,\n  setLanguage: function(lang_tag) {\n    var isAborted, self;\n    self = this;\n    if (typeof this._abortPreviousSetLang === \"function\") {\n      this._abortPreviousSetLang();\n    }\n    isAborted = false;\n    this._abortPreviousSetLang = function() {\n      return isAborted = true;\n    };\n    return this._loadLanguage(lang_tag).then((function(_this) {\n      return function() {\n        if (!isAborted) {\n          TAPi18next.setLng(lang_tag);\n          _this._language_changed_tracker.changed();\n          return Session.set(_this._loaded_lang_session_key, lang_tag);\n        }\n      };\n    })(this));\n  },\n  getLanguage: function() {\n    var session_lang;\n    if (!this._enabled()) {\n      return null;\n    }\n    session_lang = Session.get(this._loaded_lang_session_key);\n    if (session_lang != null) {\n      return session_lang;\n    } else {\n      return this._fallback_language;\n    }\n  }\n});\n","sourceMap":{"version":3,"file":"/lib/tap_i18n/tap_i18n-client.coffee.js","sourceRoot":"","sources":["/packages/tap_i18n/lib/tap_i18n/tap_i18n-client.coffee"],"names":[],"mappings":"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"}}