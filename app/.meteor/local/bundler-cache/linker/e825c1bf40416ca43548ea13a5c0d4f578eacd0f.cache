[{"type":"js","data":"//////////////////////////////////////////////////////////////////////////\n//                                                                      //\n// This is a generated file. You can view the original                  //\n// source in your browser if your browser supports source maps.         //\n// Source maps are supported by all recent versions of Chrome, Safari,  //\n// and Firefox, and by Internet Explorer 11.                            //\n//                                                                      //\n//////////////////////////////////////////////////////////////////////////\n\n\n(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar _ = Package.underscore._;\nvar Mongo = Package.mongo.Mongo;\nvar PersistentMinimongo = Package['frozeman:persistent-minimongo'].PersistentMinimongo;\nvar Web3 = Package['ethereum:web3'].Web3;\nvar BigNumber = Package['ethereum:web3'].BigNumber;\n\n/* Package-scope variables */\nvar EthAccounts;\n\n(function(){\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                    //\n// packages/ethereum_accounts/accounts.js                                                                             //\n//                                                                                                                    //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                      //\n/**                                                                                                                   // 1\n                                                                                                                      // 2\n@module Ethereum:accounts                                                                                             // 3\n*/                                                                                                                    // 4\n                                                                                                                      // 5\n                                                                                                                      // 6\n                                                                                                                      // 7\n/**                                                                                                                   // 8\nThe accounts collection, with some ethereum additions.                                                                // 9\n                                                                                                                      // 10\n@class EthAccounts                                                                                                    // 11\n@constructor                                                                                                          // 12\n*/                                                                                                                    // 13\nvar collection = new Mongo.Collection('ethereum_accounts', {connection: null});                                       // 14\nEthAccounts = _.clone(collection);                                                                                    // 15\nEthAccounts._collection = collection;                                                                                 // 16\n                                                                                                                      // 17\n                                                                                                                      // 18\nif(typeof PersistentMinimongo !== 'undefined')                                                                        // 19\n    new PersistentMinimongo(EthAccounts._collection);                                                                 // 20\n                                                                                                                      // 21\n                                                                                                                      // 22\nEthAccounts._watching = false;                                                                                        // 23\n                                                                                                                      // 24\n/**                                                                                                                   // 25\nUpdates the accounts balances, by watching for new blocks and checking the balance.                                   // 26\n                                                                                                                      // 27\n@method _watchBalance                                                                                                 // 28\n*/                                                                                                                    // 29\nEthAccounts._watchBalance = function(){                                                                               // 30\n    var _this = this;                                                                                                 // 31\n                                                                                                                      // 32\n    this._watching = true;                                                                                            // 33\n                                                                                                                      // 34\n    // UPDATE SIMPLE ACCOUNTS balance on each new block                                                               // 35\n    web3.eth.filter('latest').watch(function(e, res){                                                                 // 36\n        if(!e) {                                                                                                      // 37\n            _this._updateBalance();                                                                                   // 38\n        }                                                                                                             // 39\n    });                                                                                                               // 40\n};                                                                                                                    // 41\n                                                                                                                      // 42\n/**                                                                                                                   // 43\nUpdates the accounts balances.                                                                                        // 44\n                                                                                                                      // 45\n@method _updateBalance                                                                                                // 46\n*/                                                                                                                    // 47\nEthAccounts._updateBalance = function(){                                                                              // 48\n    var _this = this;                                                                                                 // 49\n                                                                                                                      // 50\n    _.each(EthAccounts.find({                                                                                         // 51\n        network: _this.network,                                                                                       // 52\n    }).fetch(), function(account){                                                                                    // 53\n        web3.eth.getBalance(account.address, function(err, res){                                                      // 54\n            if(!err) {                                                                                                // 55\n                EthAccounts.update(account._id, {                                                                     // 56\n                    $set: {                                                                                           // 57\n                        balance: res.toString(10)                                                                     // 58\n                    }                                                                                                 // 59\n                });                                                                                                   // 60\n            }                                                                                                         // 61\n        });                                                                                                           // 62\n    });                                                                                                               // 63\n}                                                                                                                     // 64\n                                                                                                                      // 65\n/**                                                                                                                   // 66\nUpdates the accounts list,                                                                                            // 67\nif its finds a difference between the accounts in the collection and the accounts in the accounts array.              // 68\n                                                                                                                      // 69\n@method _addAccounts                                                                                                  // 70\n*/                                                                                                                    // 71\nEthAccounts._addAccounts = function(){                                                                                // 72\n    var _this = this;                                                                                                 // 73\n                                                                                                                      // 74\n    // UPDATE normal accounts on start                                                                                // 75\n    web3.eth.getAccounts(function(e, accounts){                                                                       // 76\n        if(!e) {                                                                                                      // 77\n            var visibleAccounts = _.pluck(EthAccounts.find().fetch(), 'address');                                     // 78\n                                                                                                                      // 79\n                                                                                                                      // 80\n            if(!_.isEmpty(accounts) &&                                                                                // 81\n                _.difference(accounts, visibleAccounts).length === 0 &&                                               // 82\n                _.difference(visibleAccounts, accounts).length === 0)                                                 // 83\n                return;                                                                                               // 84\n                                                                                                                      // 85\n                                                                                                                      // 86\n            var localAccounts = EthAccounts.findAll().fetch();                                                        // 87\n                                                                                                                      // 88\n            // if the accounts are different, update the local ones                                                   // 89\n            _.each(localAccounts, function(account){                                                                  // 90\n                                                                                                                      // 91\n                // needs to have the balance                                                                          // 92\n                if(!account.balance)                                                                                  // 93\n                    return;                                                                                           // 94\n                                                                                                                      // 95\n                // set status deactivated, if it seem to be gone                                                      // 96\n                if(!_.contains(accounts, account.address)) {                                                          // 97\n                    EthAccounts.updateAll(account._id, {                                                              // 98\n                        $set: {                                                                                       // 99\n                            deactivated: true                                                                         // 100\n                        }                                                                                             // 101\n                    });                                                                                               // 102\n                } else {                                                                                              // 103\n                    EthAccounts.updateAll(account._id, {                                                              // 104\n                        $unset: {                                                                                     // 105\n                            deactivated: ''                                                                           // 106\n                        }                                                                                             // 107\n                    });                                                                                               // 108\n                }                                                                                                     // 109\n                                                                                                                      // 110\n                accounts = _.without(accounts, account.address);                                                      // 111\n            });                                                                                                       // 112\n                                                                                                                      // 113\n            // ADD missing accounts                                                                                   // 114\n            var accountsCount = visibleAccounts.length + 1;                                                           // 115\n            _.each(accounts, function(address){                                                                       // 116\n                                                                                                                      // 117\n                web3.eth.getBalance(address, function(e, balance){                                                    // 118\n                    if(!e) {                                                                                          // 119\n                        web3.eth.getCoinbase(function(e, coinbase){                                                   // 120\n                            var doc = EthAccounts.findAll({                                                           // 121\n                                address: address,                                                                     // 122\n                            }).fetch()[0];                                                                            // 123\n                                                                                                                      // 124\n                            var insert = {                                                                            // 125\n                                type: 'account',                                                                      // 126\n                                address: address,                                                                     // 127\n                                balance: balance.toString(10),                                                        // 128\n                                name: (address === coinbase) ? 'Main account (Etherbase)' : 'Account '+ accountsCount\n                            };                                                                                        // 130\n                                                                                                                      // 131\n                            if(doc) {                                                                                 // 132\n                                EthAccounts.updateAll(doc._id, {                                                      // 133\n                                    $set: insert                                                                      // 134\n                                });                                                                                   // 135\n                            } else {                                                                                  // 136\n                                EthAccounts.insert(insert);                                                           // 137\n                            }                                                                                         // 138\n                                                                                                                      // 139\n                            if(address !== coinbase)                                                                  // 140\n                                accountsCount++;                                                                      // 141\n                        });                                                                                           // 142\n                    }                                                                                                 // 143\n                });                                                                                                   // 144\n                                                                                                                      // 145\n            });                                                                                                       // 146\n        }                                                                                                             // 147\n    });                                                                                                               // 148\n};                                                                                                                    // 149\n                                                                                                                      // 150\n                                                                                                                      // 151\n                                                                                                                      // 152\n/**                                                                                                                   // 153\nBuilds the query with the addition of \"{deactivated: {$exists: false}}\"                                               // 154\n                                                                                                                      // 155\n@method _addToQuery                                                                                                   // 156\n@param {Mixed} arg                                                                                                    // 157\n@param {Object} options                                                                                               // 158\n@param {Object} options.includeDeactivated If set then de-activated accounts are also included.                       // 159\n@return {Object} The query                                                                                            // 160\n*/                                                                                                                    // 161\nEthAccounts._addToQuery = function(args, options){                                                                    // 162\n    var _this = this;                                                                                                 // 163\n                                                                                                                      // 164\n    options = _.extend({                                                                                              // 165\n        includeDeactivated: false                                                                                     // 166\n    }, options);                                                                                                      // 167\n                                                                                                                      // 168\n    var args = Array.prototype.slice.call(args);                                                                      // 169\n                                                                                                                      // 170\n    if(_.isObject(args[0])) {                                                                                         // 171\n        args[0] = _.extend(args[0], {                                                                                 // 172\n            network: _this.network,                                                                                   // 173\n        });                                                                                                           // 174\n    }                                                                                                                 // 175\n    else if(_.isString(args[0])) {                                                                                    // 176\n        args[0] = {                                                                                                   // 177\n            network: _this.network,                                                                                   // 178\n            _id: args[0],                                                                                             // 179\n        };                                                                                                            // 180\n    }                                                                                                                 // 181\n    else {                                                                                                            // 182\n        args[0] = {                                                                                                   // 183\n            network: _this.network,                                                                                   // 184\n        };                                                                                                            // 185\n    }                                                                                                                 // 186\n                                                                                                                      // 187\n    if (!options.includeDeactivated) {                                                                                // 188\n        args[0] = _.extend(args[0], {                                                                                 // 189\n            deactivated: {$exists: false}                                                                             // 190\n        });                                                                                                           // 191\n    }                                                                                                                 // 192\n                                                                                                                      // 193\n    return args;                                                                                                      // 194\n};                                                                                                                    // 195\n                                                                                                                      // 196\n                                                                                                                      // 197\n/**                                                                                                                   // 198\nFind all accounts, besides the deactivated ones                                                                       // 199\n                                                                                                                      // 200\n@method find                                                                                                          // 201\n@return {Object} cursor                                                                                               // 202\n*/                                                                                                                    // 203\nEthAccounts.find = function(){                                                                                        // 204\n    return this._collection.find.apply(this, this._addToQuery(arguments));                                            // 205\n};                                                                                                                    // 206\n                                                                                                                      // 207\n/**                                                                                                                   // 208\nFind all accounts, including the deactivated ones                                                                     // 209\n                                                                                                                      // 210\n@method findAll                                                                                                       // 211\n@return {Object} cursor                                                                                               // 212\n*/                                                                                                                    // 213\nEthAccounts.findAll = function() {                                                                                    // 214\n    return this._collection.find.apply(this, this._addToQuery(arguments, {                                            // 215\n        includeDeactivated: true                                                                                      // 216\n    }));                                                                                                              // 217\n}                                                                                                                     // 218\n                                                                                                                      // 219\n/**                                                                                                                   // 220\nFind one accounts, besides the deactivated ones                                                                       // 221\n                                                                                                                      // 222\n@method findOne                                                                                                       // 223\n@return {Object} cursor                                                                                               // 224\n*/                                                                                                                    // 225\nEthAccounts.findOne = function(){                                                                                     // 226\n    return this._collection.findOne.apply(this, this._addToQuery(arguments));                                         // 227\n};                                                                                                                    // 228\n                                                                                                                      // 229\n/**                                                                                                                   // 230\nUpdate accounts, besides the deactivated ones                                                                         // 231\n                                                                                                                      // 232\n@method update                                                                                                        // 233\n@return {Object} cursor                                                                                               // 234\n*/                                                                                                                    // 235\nEthAccounts.update = function(){                                                                                      // 236\n    return this._collection.update.apply(this, this._addToQuery(arguments));                                          // 237\n};                                                                                                                    // 238\n                                                                                                                      // 239\n/**                                                                                                                   // 240\nUpdate accounts, including the deactivated ones                                                                       // 241\n                                                                                                                      // 242\n@method updateAll                                                                                                     // 243\n@return {Object} cursor                                                                                               // 244\n*/                                                                                                                    // 245\nEthAccounts.updateAll = function() {                                                                                  // 246\n    return this._collection.update.apply(this, this._addToQuery(arguments, {                                          // 247\n        includeDeactivated: true                                                                                      // 248\n    }));                                                                                                              // 249\n}                                                                                                                     // 250\n                                                                                                                      // 251\n/**                                                                                                                   // 252\nUpdate accounts, including the deactivated ones                                                                       // 253\n                                                                                                                      // 254\n@method upsert                                                                                                        // 255\n@return {Object} cursor                                                                                               // 256\n*/                                                                                                                    // 257\nEthAccounts.upsert = function() {                                                                                     // 258\n    return this._collection.upsert.apply(this, this._addToQuery(arguments, {                                          // 259\n        includeDeactivated: true                                                                                      // 260\n    }));                                                                                                              // 261\n}                                                                                                                     // 262\n                                                                                                                      // 263\n/**                                                                                                                   // 264\nInsert an account                                                                                                     // 265\n                                                                                                                      // 266\n@method insert                                                                                                        // 267\n@return {Object} cursor                                                                                               // 268\n*/                                                                                                                    // 269\nEthAccounts.insert = function(data) {                                                                                 // 270\n    return this._collection.insert.call(this, _.extend(data, {                                                        // 271\n        network: this.network,                                                                                        // 272\n    }));                                                                                                              // 273\n}                                                                                                                     // 274\n                                                                                                                      // 275\n                                                                                                                      // 276\n/**                                                                                                                   // 277\nStarts fetching and watching the accounts                                                                             // 278\n                                                                                                                      // 279\n@param opts Configuration options                                                                                     // 280\n@param opts.network Unique id of network we're on                                                                     // 281\n                                                                                                                      // 282\n@method init                                                                                                          // 283\n*/                                                                                                                    // 284\nEthAccounts.init = function(opts) {                                                                                   // 285\n    var _this = this;                                                                                                 // 286\n                                                                                                                      // 287\n    if(typeof web3 === 'undefined') {                                                                                 // 288\n        console.warn('EthAccounts couldn\\'t find web3, please make sure to instantiate a web3 object before calling EthAccounts.init()');\n        return;                                                                                                       // 290\n    }                                                                                                                 // 291\n                                                                                                                      // 292\n    if (opts && !opts.network) {                                                                                      // 293\n        throw new Error('Network id not given');                                                                      // 294\n    } else if (opts && opts.network) {                                                                                // 295\n        // network id                                                                                                 // 296\n        _this.network = opts.network;                                                                                 // 297\n    }                                                                                                                 // 298\n                                                                                                                      // 299\n                                                                                                                      // 300\n    /**                                                                                                               // 301\n    Overwrite web3.reset, to also stop the interval                                                                   // 302\n                                                                                                                      // 303\n    @method web3.reset                                                                                                // 304\n    */                                                                                                                // 305\n    web3._reset = Web3.prototype.reset;                                                                               // 306\n    web3.reset = function(keepIsSyncing){                                                                             // 307\n        Meteor.clearInterval(_this._intervalId);                                                                      // 308\n        _this._watching = false;                                                                                      // 309\n        web3._reset(keepIsSyncing);                                                                                   // 310\n    };                                                                                                                // 311\n                                                                                                                      // 312\n    Tracker.nonreactive(function(){                                                                                   // 313\n                                                                                                                      // 314\n        _this._addAccounts();                                                                                         // 315\n                                                                                                                      // 316\n        if(!_this._watching) {                                                                                        // 317\n            _this._updateBalance();                                                                                   // 318\n            _this._watchBalance();                                                                                    // 319\n                                                                                                                      // 320\n            // check for new accounts every 2s                                                                        // 321\n            Meteor.clearInterval(_this._intervalId);                                                                  // 322\n            _this._intervalId = Meteor.setInterval(function(){                                                        // 323\n                _this._addAccounts();                                                                                 // 324\n            }, 2000);                                                                                                 // 325\n        }                                                                                                             // 326\n    });                                                                                                               // 327\n};                                                                                                                    // 328\n                                                                                                                      // 329\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n/* Exports */\nif (typeof Package === 'undefined') Package = {};\n(function (pkg, symbols) {\n  for (var s in symbols)\n    (s in pkg) || (pkg[s] = symbols[s]);\n})(Package['ethereum:accounts'] = {}, {\n  EthAccounts: EthAccounts\n});\n\n})();\n","servePath":"/packages/ethereum_accounts.js"}]